{% extends 'catalog/base.html' %}

{% block title %}Biblioteca{% endblock %}

{% block content %}
  <div class="library-layout">
    <aside class="sidebar">
      <form method="get" id="filters-form">
        <div class="filter-block">
          <label for="q">Buscar</label>
          <input type="search" name="q" id="q" placeholder="Buscar título..." value="{{ q }}" />
        </div>

        <div class="filter-block">
          <h4>Géneros</h4>
          {% include "catalog/_genres_list.html" %}
        </div>

        <div class="filter-block">
          <h4>Tipo</h4>
          <label><input type="checkbox" name="type" value="movie" {% if 'movie' in selected_types %}checked{% endif %}/> Película</label><br/>
          <label><input type="checkbox" name="type" value="series" {% if 'series' in selected_types %}checked{% endif %}/> Serie</label>
        </div>

        <div class="filter-block">
          <h4>Ordenar</h4>
          <select name="sort">
            <option value="pop_desc" {% if sort == 'pop_desc' %}selected{% endif %}>Popularidad (desc)</option>
            <option value="pop_asc" {% if sort == 'pop_asc' %}selected{% endif %}>Popularidad (asc)</option>
            <option value="title_asc" {% if sort == 'title_asc' %}selected{% endif %}>Título A→Z</option>
            <option value="title_desc" {% if sort == 'title_desc' %}selected{% endif %}>Título Z→A</option>
          </select>
        </div>

        <input type="hidden" name="page_size" id="id_page_size" value="{{ page_size }}" />

        <div class="filter-actions">
          <button type="button" class="page-size-btn{% if page_size == 25 %} active{% endif %}" data-size="25">25</button>
          <button type="button" class="page-size-btn{% if page_size == 50 %} active{% endif %}" data-size="50">50</button>
          <button type="button" class="page-size-btn{% if page_size == 100 %} active{% endif %}" data-size="100">100</button>
        </div>
      </form>
    </aside>

    <section class="content-area">
      <div class="platform-selector">
        <form id="platforms-form">
          {% for p in supported_platforms %}
            <label class="platform-chip" title="{{ p.name }}">
              <input type="checkbox" name="platforms" value="{{ p.slug }}" {% if p.slug in selected_platforms %}checked{% endif %} />
              <img src="/static/logos/{{ p.slug }}.svg" alt="{{ p.name }}" onerror="this.onerror=null;this.src='/static/logos/{{ p.slug }}.png'" />
              <span class="platform-name">{{ p.name }}</span>
            </label>
          {% endfor %}
        </form>
      </div>

      <div id="titles-fragment">
        {% include "catalog/_titles_grid.html" %}
      </div>
    </section>
  </div>

  <div id="title-detail-modal"></div>

  <script>
    // Modal functions
    async function showTitleDetail(titleId){
      try{
        const res = await fetch(`/title/${titleId}/detail`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if(!res.ok) return;
        const data = await res.json();
        document.getElementById('title-detail-modal').innerHTML = data.detail_html;
      }catch(err){ console.error('detail fetch', err); }
    }
    function closeTitleDetail(){ document.getElementById('title-detail-modal').innerHTML = ''; }

    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeTitleDetail(); });

    // AJAX-driven filtering and pagination
    (function(){
      const container = document.getElementById('titles-fragment');
      const form = document.getElementById('filters-form');
      const platformForm = document.getElementById('platforms-form');
      if(!container || !form) return;

      let debounceTimer;

      function buildUrl(page){
        const params = new URLSearchParams();
        const fd = new FormData(form);
        for(const [k,v] of fd.entries()) if(k!=='page_size') params.append(k,v);
        if(platformForm){ const pfd = new FormData(platformForm); pfd.getAll('platforms').forEach(p=>params.append('platforms',p)); }
        params.append('page_size', document.getElementById('id_page_size').value || '25');
        if(page) params.set('page', page);
        const firstPlatform = (platformForm && platformForm.querySelector('input[name="platforms"]:checked')) ? platformForm.querySelector('input[name="platforms"]:checked').value : 'netflix';
        return `/platform/${firstPlatform}/data?` + params.toString();
      }

      async function loadPage(page){
        const url = buildUrl(page);
        try{
          const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if(!res.ok) return;
          const data = await res.json();
          container.innerHTML = data.titles_html;
          const genresHolder = document.querySelector('.filter-block .genres-list');
          if(genresHolder && data.genres_html) genresHolder.innerHTML = data.genres_html;
          attachPaginationLinks();
        }catch(e){ console.error('AJAX', e); }
      }

      function onPageClick(e){ e.preventDefault(); loadPage(e.currentTarget.dataset.page); }
      function attachPaginationLinks(){
        container.querySelectorAll('.ajax-page').forEach(a=>{ a.removeEventListener('click', onPageClick); a.addEventListener('click', onPageClick); });
      }

      function triggerFiltersChange(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(()=> loadPage(1), 300); }

      form.addEventListener('input', triggerFiltersChange);
      form.addEventListener('change', triggerFiltersChange);
      if(platformForm) platformForm.addEventListener('change', triggerFiltersChange);

      document.querySelectorAll('.page-size-btn').forEach(btn=> btn.addEventListener('click', (e)=>{ document.querySelectorAll('.page-size-btn').forEach(b=>b.classList.remove('active')); e.currentTarget.classList.add('active'); document.getElementById('id_page_size').value = e.currentTarget.dataset.size; triggerFiltersChange(); }));

      attachPaginationLinks();
    })();
  </script>
{% endblock %}
